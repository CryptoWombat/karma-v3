<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Karma API Test Harness</title>
  <style>
    :root { --bg: #1a1a2e; --card: #16213e; --accent: #0f3460; --text: #e8e8e8; --ok: #00c853; --err: #ff1744; }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    h1 { margin-bottom: 8px; }
    .sub { color: #888; margin-bottom: 20px; }
    .config { background: var(--card); padding: 16px; border-radius: 8px; margin-bottom: 20px; }
    .config label { display: block; margin-bottom: 8px; }
    .config input { width: 100%; max-width: 400px; padding: 8px; background: var(--accent); border: 1px solid #333; color: var(--text); border-radius: 4px; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 8px; margin-bottom: 8px; }
    .btn-primary { background: var(--ok); color: #000; }
    .btn-secondary { background: var(--accent); color: var(--text); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .result { background: var(--card); padding: 16px; border-radius: 8px; margin-top: 16px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    .result.ok { border-left: 4px solid var(--ok); }
    .result.fail { border-left: 4px solid var(--err); }
    .suite { margin-top: 24px; }
    .suite h3 { margin-bottom: 12px; }
    .step { margin-bottom: 12px; }
    .step-label { font-weight: 600; margin-bottom: 4px; }
  </style>
</head>
<body>
  <h1>Karma Platform v3 â€“ API Test Harness</h1>
  <p class="sub">Visual verification of API endpoints. Use with Playwright for automated UI tests.</p>

  <div class="config">
    <label>API Base URL</label>
    <input type="text" id="baseUrl" value="http://localhost:8000" placeholder="http://localhost:8000">
    <label style="margin-top: 12px;">Admin API Key (for mint)</label>
    <input type="password" id="adminKey" value="test-admin-key" placeholder="Bearer token">
  </div>

  <div class="suite">
    <h3>Quick Actions</h3>
    <button class="btn btn-primary" onclick="runHealth()">Health Check</button>
    <button class="btn btn-secondary" onclick="runFullFlow()">Run Full Flow</button>
  </div>

  <div id="output" class="result" style="display:none;"></div>

  <script>
    const base = () => document.getElementById('baseUrl').value.replace(/\/$/, '');
    const adminKey = () => document.getElementById('adminKey').value;
    const out = (text, ok) => {
      const el = document.getElementById('output');
      el.textContent = text;
      el.className = 'result ' + (ok ? 'ok' : 'fail');
      el.style.display = 'block';
    };

    async function runHealth() {
      try {
        const r = await fetch(base() + '/health');
        const j = await r.json();
        out('GET /health\n' + r.status + ' ' + r.statusText + '\n\n' + JSON.stringify(j, null, 2), r.ok);
      } catch (e) {
        out('Error: ' + e.message, false);
      }
    }

    async function runFullFlow() {
      const steps = [];
      const log = (msg, data) => steps.push(msg + (data ? '\n' + JSON.stringify(data, null, 2) : ''));
      try {
        const url = base();
        const key = adminKey();

        const r1 = await fetch(url + '/v1/users/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: '99901', username: 'harness_alice' })
        });
        const j1 = await r1.json();
        log('1. Register alice', j1);
        if (!r1.ok) throw new Error('Register failed');

        const r2 = await fetch(url + '/v1/users/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: '99902', username: 'harness_bob' })
        });
        const j2 = await r2.json();
        log('2. Register bob', j2);

        const r3 = await fetch(url + '/v1/admin/mint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
          body: JSON.stringify({ user_id: '99901', amount: 200 })
        });
        const j3 = await r3.json();
        log('3. Mint 200 to alice', j3);
        if (!r3.ok) throw new Error('Mint failed: ' + (j3.detail || j3.message));

        const r4 = await fetch(url + '/v1/wallets/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sender_id: '99901', recipient_id: '99902', amount: 50 })
        });
        const j4 = await r4.json();
        log('4. Send 50 from alice to bob', j4);
        if (!r4.ok) throw new Error('Send failed');

        const r5a = await fetch(url + '/v1/users/balance/99901');
        const r5b = await fetch(url + '/v1/users/balance/99902');
        const j5a = await r5a.json();
        const j5b = await r5b.json();
        log('5. Balances: alice=' + j5a.balance + ', bob=' + j5b.balance, { alice: j5a, bob: j5b });

        const r6 = await fetch(url + '/v1/stats');
        const j6 = await r6.json();
        log('6. Public stats', j6);

        out(steps.join('\n\n'), j5a.balance === 150 && j5b.balance === 50);
      } catch (e) {
        out(steps.join('\n\n') + '\n\nERROR: ' + e.message, false);
      }
    }
  </script>
</body>
</html>
